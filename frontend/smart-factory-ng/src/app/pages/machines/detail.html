<div class="machine-detail" *ngIf="machine() as m">
  <header class="bar">
    <h2>{{ m.name }}</h2>
    <span class="badge" [class.running]="m.status==='running'" [class.stopped]="m.status==='stopped'"
      [class.setup]="m.status==='setup'">
      {{ m.status }}
    </span>
  </header>

  <section class="meta card">
    <div><strong>Code :</strong> {{ m.code }}</div>
    <div><strong>Cadence cible :</strong> {{ m.target_rate_per_hour }} / h</div>
  </section>

  <!-- KPIs -->
  <section class="kpis row g-3">
    <!-- KPI Journée (24h) -->
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-header">KPI — Dernières 24h</div>
        <div class="card-body">
          <div *ngIf="!kpiDay()">Chargement…</div>
          <ng-container *ngIf="kpiDay() as k">
            <div class="d-flex flex-wrap gap-4">
              <div>
                <div class="text-muted">Bons</div>
                <div class="display-6 fw-bold text-succes">{{ k.good }}</div>
              </div>
              <div>
                <div class="text-muted">Rebuts</div>
                <div class="display-6 fw-bold text-danger">{{ k.scrap }}</div>
              </div>
              <div>
                <div class="text-muted">Qualité (TRS)</div>
                <div class="display-6 fw-bold">{{ k.trs }}%</div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- KPI Global -->
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-header">KPI — Global</div>
        <div class="card-body">
          <div *ngIf="!kpiAll()">Chargement…</div>
          <ng-container *ngIf="kpiAll() as k">
            <div class="d-flex flex-wrap gap-4">
              <div>
                <div class="text-muted">Bons</div>
                <div class="display-6 fw-bold text-succes">{{ k.good }}</div>
              </div>
              <div>
                <div class="text-muted">Rebuts</div>
                <div class="display-6 fw-bold text-danger">{{ k.scrap }}</div>
              </div>
              <div>
                <div class="text-muted">Qualité (TRS)</div>
                <div class="display-6 fw-bold">{{ k.trs }}%</div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </section>

  <section class="events card">
    <h3>Derniers événements</h3>
    <p *ngIf="!events().length" class="muted">Aucun événement récent.</p>
    <ul class="list">
      <li *ngFor="let ev of events()">
        <span class="dot" [class.good]="ev.event_type==='good'" [class.scrap]="ev.event_type==='scrap'"
          [class.stop]="ev.event_type==='stop'"></span>
        <span class="type">{{ ev.event_type }}</span>
        <span class="qty" *ngIf="ev.event_type!=='stop'">×{{ ev.qty }}</span>
        <span class="at">{{ ev.happened_at | date:'short':tz }}</span>
        <span class="wo" *ngIf="ev.work_order_number">— OF {{ ev.work_order_number }}</span>
        <span class="notes" *ngIf="ev.notes">• {{ ev.notes }}</span>
      </li>
    </ul>
  </section>
</div>

<p *ngIf="loading()">Chargement…</p>
<p *ngIf="error()" class="error">{{ error() }}</p>
