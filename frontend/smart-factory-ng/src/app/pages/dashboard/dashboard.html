<!-- En-tête de section -->
<div class="section-title">
  <h1>Tableau de bord</h1>
  <span class="hint">Vue d’ensemble de l’usine</span>
  <button class="btn btn-primary btn-sm ms-auto" (click)="refresh()" [disabled]="loading()">
    Rafraîchir
  </button>
</div>

<!-- Erreur éventuelle -->
<div *ngIf="error()" class="alert alert-danger py-2">{{ error() }}</div>

<!-- Résumé KPI rapide (3 tuiles) -->
<div class="row g-3 mb-2">
  <div class="col-12 col-sm-6 col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h3 class="mb-0">Machines</h3>
          <span class="text-muted">Total</span>
        </div>
        <div class="display-6 fw-extrabold mt-1">{{ total }}</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-sm-6 col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h3 class="mb-0">TRS</h3>
          <span class="text-muted">Dernière heure</span>
        </div>
        <div class="display-6 fw-extrabold mt-1">{{ trs }}%</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h3 class="mb-0">États</h3>
          <span class="text-muted">Répartition</span>
        </div>
        <div class="mt-2 d-flex flex-wrap gap-2">
          <span class="badge badge-running">Running {{ running }}</span>
          <span class="badge badge-stopped">Stopped {{ stopped }}</span>
          <span class="badge badge-setup">Setup {{ setup }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Donut + Activités récentes -->
<div class="row g-3">
  <!-- Donut -->
  <div class="col-12 col-lg-5">
    <div class="card h-100">
      <div class="card-header">Répartition des machines</div>
      <div class="card-body">
        <div class="sf-donut">
          <canvas baseChart [data]="pieData" [options]="pieOptions">
          </canvas>

          <!-- Valeur au centre -->
          <div class="sf-donut__center">
            <div class="text-center">
              <div class="value">{{ total }}</div>
              <div class="sub">Machines</div>
            </div>
          </div>
        </div>

        <!-- Légende personnalisée -->
        <div class="d-flex flex-wrap gap-3 mt-3">
          <div class="d-flex align-items-center gap-2">
            <span class="legend-dot legend-green"></span>
            <span class="fw-semibold">Running</span>
            <span class="badge badge-running ms-2">{{ running }}</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="legend-dot legend-red"></span>
            <span class="fw-semibold">Stopped</span>
            <span class="badge badge-stopped ms-2">{{ stopped }}</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="legend-dot legend-amber"></span>
            <span class="fw-semibold">Setup</span>
            <span class="badge badge-setup ms-2">{{ setup }}</span>
          </div>
          <span class="ms-auto text-muted">TRS moyen : <strong>{{ trs }}%</strong></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Activités récentes (depuis /dashboard/summary.recent) -->
  <div class="col-12 col-lg-7">
    <div class="card h-100">
      <div class="card-header">Activités récentes</div>
      <div class="card-body p-0">
        <div *ngIf="!summary()?.recent?.length" class="p-3 text-muted">Aucune activité récente.</div>

        <ul *ngIf="summary()?.recent?.length" class="list-group list-group-flush">
          <li *ngFor="let a of summary().recent" class="list-group-item">
            <small class="text-muted">{{ a.happened_at | date:'short' }}</small>
            — <strong>{{ a.machine_name || 'N/A' }}</strong> ({{a.machine_code}})
            — {{ a.event_type }} ({{ a.qty }})
            <span *ngIf="a.work_order_number" class="text-muted">— OF {{ a.work_order_number }}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
